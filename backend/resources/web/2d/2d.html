<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        canvas {
            width: 100%;
            height: 100%;
            display: block;

            -moz-transform: scale(1, -1);
            -o-transform: scale(1, -1);
            -webkit-transform: scale(1, -1);
            transform: scale(1, -1);
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <script>
        const width = 440;   // must match server's frame width
        const height = 240;  // must match server's frame height

        const canvas = document.getElementById("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        // Decode Base64 â†’ ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const buffer = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                buffer[i] = binary.charCodeAt(i);
            }
            return buffer.buffer;
        }

        function connect() {
            const ip = "localhost";
            const port = 6671;

            const socket = new WebSocket(`ws://${ip}:${port}/socket`);

            socket.addEventListener("open", () => {
                console.log("WebSocket opened");
            });

            socket.addEventListener("message", (event) => {
                // Server sends Base64 string of raw RGBA buffer
                const base64Data = event.data;
                const buffer = base64ToArrayBuffer(base64Data);

                const pixels = new Uint8ClampedArray(buffer); // RGBA expected
                const imageData = new ImageData(pixels, width, height);

                ctx.putImageData(imageData, 0, 0);
            });

            // --- Input event handling ---
            let mouseInCanvas = false;

            function sendInput(data) {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(data));
                }
            }

            canvas.addEventListener("mouseenter", () => {
                mouseInCanvas = true;
            });
            canvas.addEventListener("mouseleave", () => {
                mouseInCanvas = false;
            });

            canvas.addEventListener("mousemove", (e) => {
                if (!mouseInCanvas) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;
                sendInput({ type: "mouse_move", x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) });
            });

            canvas.addEventListener("mousedown", (e) => {
                if (!mouseInCanvas) return;
                // button: 0=left, 2=right
                if (e.button === 0 || e.button === 2) {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    sendInput({ type: "mouse_down", button: e.button, x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) });
                }
            });

            canvas.addEventListener("mouseup", (e) => {
                if (!mouseInCanvas) return;
                if (e.button === 0 || e.button === 2) {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    sendInput({ type: "mouse_up", button: e.button, x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) });
                }
            });

            // Keyboard events (window-level, but only send if mouse is in canvas)
            window.addEventListener("keydown", (e) => {
                if (!mouseInCanvas) return;
                sendInput({ type: "key_down", key: e.keyCode, code: e.code });
            });
            window.addEventListener("keyup", (e) => {
                if (!mouseInCanvas) return;
                sendInput({ type: "key_up", key: e.keyCode, code: e.code });
            });

            socket.addEventListener("close", () => {
                console.log("Failed to connect, retrying in 3 seconds");
                setTimeout(connect, 3000);
            });
        }

        connect();
    </script>
</body>
</html>
